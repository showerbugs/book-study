# Chapter 2. 파일 입출력

## Overview

유닉스에서는 모든 것을 파일로 표현하기 때문에 파일 입출력은 매우 중요한 부분이다.

- 이 장에서는 파일 입출력의 기본을 알아보고 파일을 다루는 시스템 콜을 알아본다.

```cpp
int fd = open("/home/amazingguni/asdf.txt", O_RDWR);

unsigned long word;
read(fd, &word, sizeof(unsigned long));

const char *buf = "hi everyone";
write(fd, buf, strlen(buf));

```

파일은 읽거나 쓰기 전에 반드시 열어야 한다. 이 때 커널은 프로세스별로 파일 테이블을 관리한다.

- 이 파일 테이블은 `File discripter`(흔히 fd라고 부르는)로 인덱싱 되어 있음
- 테이블의 각 항목은 열린 파일에 대한 정보를 담고 있음
	- 메모리에 복사된 inode를 가리키는 포인터
	- 파일 위치와 접근 모드(r/w)와 같은 메타 데이터
- `fd`는 사용자 영역, 커널 영역 모두에서 프로세스 내에서 고유한 식별자로 쓰임
- 파일을 열면 `fd`가 반환되고 이걸 통해 읽기 쓰기 등 연산을 수행

![file descriptor](http://poincare.matf.bg.ac.rs/~ivana/courses/ps/sistemi_knjige/pomocno/apue/APUE/0201433079/images/0201433079/graphics/17fig18.gif;423615)

프로세스에서 명시적으로 닫지 않는다면 모든 프로세서는 아래 3개의 `fd`를 열어두고 있다.

- 0 - 표준 입력(stdin) 
	- C에서는 STDIN_FILENO로 정의
	- 키보드 같은 터미널의 입력장치에 연결
- 1 - 표준 출력(stdout)
	- STDOUT_FILENO
	- 터미널의 출력 장치에 연결
- 2 - 표준 에러(stderr) 
	- STDERR_FILENO

사용자는 이런 표준 `fd`를 리다이렉트하거나 파이프를 사용해서 한 프로그램의 출력을 다른 프로그램의 입력으로 리다이렉트할 수도 있다.


![file descriptor](http://web.cs.ucla.edu/classes/fall08/cs111/scribe/4/FDT_diagram.JPG)

`fd` 는 단순히 일반 파일만 나타내지는 않는다.

- 장치 파일(usb, mount된 장비, 등등)
- 디렉터리
- 퓨텍스
	- 개발자가 기본적인 잠금을 구현하기 위해 사용되거나 세마포어, POSIX 뮤텍스, 조건 변수와 같은 상위 계층의 잠금 추상화를 위한 빌딩 블록으로서 쓰일 수 있는 리눅스 커널에서 제공하는 시스템 호출이다.
- FIFO
- 소켓 접근

기본적으로 자식 프로세스는 부모 프로세스가 소유한 파일 테이블의 복사본을 상속받는다.

- 이후 자식 프로세스에서 파일 테이블이 추가/삭제 되어도 부모 프로세스는 영향받지 않는다.

## 2.1 파일 열기

파일을 여는 시스템콜은 open(), creat()이며, 다 쓴 다음에는 close() 시스템 콜로 파일을 닫아야 한다.

### 2.1.1 open()

open() 시스템 콜을 사용해서 파일을 열고 `fd`를 얻는다.

```cpp
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int open (const char *name, int flags);
int open (const char *name, int flags, mode_t mode);
``` 

경로 이름이 name인 파일을 `fd`에 맵핑하고, 성공하면 이 `fd`를 반환한다.

파일 오프셋은 시작 지점인 0으로 설정되며 flags로 지정된 플래그에 대응하는 접근 모드로 열린다.

**open() 플래그**