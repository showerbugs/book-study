# 2.1 이더리움 플랫폼 살펴보기

이더리움은 단순한 암호화폐가 아니라 컴퓨팅 플랫폼이다.

- 이더리움 가상 머신
- 스마트 컨트랙트 개발 언어
- 이를 작동하고 관리하기 위한 다양한 서비스

를 제공한다.

## 2.1.1 이더리움 작동 과정

이더리움 커뮤니티에서 이더리움을 다음과 같이 정의한다.

> 이더리움은 정확히 프로그래밍한 대로 작동하는 스마트 컨트랙트를 작동시키는 분산 플랫폼이다.

### 이더리움 지갑 설치와 사용

**지갑 설치** 일반 사용자는 암호화폐 이더를 사용하기 위해 미스트나 이더리움 월릿을 설치한다.

**계정 생성** 암호 문구만 입력하면 계정(암호화된 16진수)이 생성된다. 이 암호의 변경은 불가능하고, 암호를 분실하면 암호화폐를 찾을 수 없다. 최초 계정을 메인 계정 혹은 이더베이스`etherbase`라고도 하는데, 마이닝 등의 작업 대가를 이 계정으로 지급 받기 때문이다.

**이더 확보** 거래소에서 이더를 구매하거나 다른 사용자에게 이더를 송금 받는다. 채굴도 가능하나 많은 장비 투자가 필요하다. 상품이나 서비스 판매 대가로 이더를 받을 수 있다.

### 모든 거래 기록의 공유 및 블록체인 구성

어떤 식으로든 이더를 지급하는 것은 계정간의 이더 이동이고, 상태 전이이다. 상태 변화를 일으키는 모든 활동을 트랜잭션이라고 부른다. 트랜잭션이 모여 하나의 블록이 만들어지고, 시간 순으로 블록이 연결되면서 블록체인이 된다.

기존 은행 등의 중앙 원장 시스템에서는 중앙 시스템이 트랜잭션의 이상 유무를 확인하고 보장해준다. 그러나 이더리움은 중앙 없이 직접 연결된 노드로만 공유되기 때문에 정보 도달 지연이나 미도달 등의 문제가 발생할 수 있다. 이 경우 중복 처리나 다른 오작동이 발생할 수 있으므로 해당 정보가 정확한지 확인할 필요가 있다.

이 확인 과정이 합의 알고리즘이다. 이더리움의 합의 알고리즘은 작업 증명`Proof of Work` 알고리즘이고, 작업 증명 알고리즘을 실제로 수행하는 사람이 채굴자다.

채굴자는 트랜잭션, 블록에 정의된 난이도보다 적은 수의 해시값을 찾는 연산을 한 후, 값을 찾으면 이를 연결된 모든 노드에게 전파하여 알린다. 가장 빠르게 이 값을 찾은 채굴자는 블록당 3이더와 블록 내의 트랜잭션 처리 비용을 함께 획득한다.

작업 증명에 성공하기 위해서는 높은 컴퓨팅 파워가 필요하기 때문에 장비 투자비와 전기 사용료를 많이 내야 하고, 대형 채굴업자에 의한 영향도 집중 등의 문제가 많다. 따라서 이더리움은 이를 해결하기 위해 지분 증명`Proof of Stake` 알고리즘으로 변경 중에 있다.

### 다양한 응용 앱 개발

이더리움은 오픈소스다. 개발 커뮤니티와 소스 코드 추가/수정에 직접 참여할 수 있다. 스위스에 있는 이더리움 재단이 이더리움의 모든 개발 과정을 운영한다. 또 스마트 컨트랙트를 이용해서 다양한 응용 서비스를 개발할 수도 있다. 이를 DApp`Decentralized App`이라고 한다.

이더리움은 솔리디티 등의 상위 스마트 컨트랙트 개발 언어로 개발된 프로그램을 바이트 코드로 컴파일 한 후 이를 블록체인에 배포하고 저장한다. 바이트 코드를 검증하고 이상이 없을 경우 이더리움 가상 머신`EVM`에서 실행 가능한 Op코드로 변환되어 실행된다. 사용자가 스마트 컨트랙트를 이용하기 위해서는 가스`Gas`라는 내부 운용 토큰을 사용 대가로 지급해야 한다.

## 2.1.2 미스트로 이더리움 이해하기

> 실제로 애플리케이션을 설치해서 둘러보는 부분이라 생략해도 됨

미스트는 표준 월릿이자 DApp 구동이 가능한 브라우저이기도 하다. 미스트는 이더리움 월릿을 포함한 브라우저이고, 이더리움 월릿은 미스트로 구현된 DApp이다. 이더리움 클라언트 Geth는 미스트에 포함되어 있다.

### 미스트 설치

[여기서](https://github.com/ethereum/mist/releases) OS에 맞는 미스트를 다운로드 하자.

1. 미스트를 실행하면 Geth가 자동으로 실행
2. 피어 노드를 자동으로 찾아 블록 데이터 다운로드 (싱크 시간이 최대 며칠까지 걸릴 수도 있으므로 부담스럽다면 동기화가 없는 월릿인 메타마스크([https://metamask.io](https://metamask.io))를 이용해도 좋다)
3. 싱크가 완료되면 네트워크 선택 (네트워크는 메인 네트워크, 테스트 네트워크(Ropsten, Rinkeby), 솔로 네트워크(개발자용 로컬)이 있다)
4. 신규 계정 생성 및 개인키 보관

### 이더리움 월릿으로 돈 주고 받기

GUI 애플리케이션에서 솔로 네트워크를 선택하면 채굴 작업을 수행하고 확보한 이더를 솔로 네트워크 내의 다른 계정에 송금 해볼 수 있다.

### 이더리움 월릿으로 스마트 컨트랙트 배포하기

1. GUI 애플리케이션에서 신규 스마트 컨트랙트를 작성

```
pragma solidity ^0.4.15;
contract MyToken {
	mapping (address => unit) public balanceOf;
	
	function MyToken (uint initialSupply) public {
		/* Constructor */
		balanceOf[msg.sender] = initialSupply;
	}
	
	function transfer (address _to, uint256 _value) public {
		require(balanceOf[msg.sender] >= _value);

		balanceOf[msg.sender] -= _value;
		balanceOf[_to] += _value;
	}
	
	function getBalance(address _account) public constant returns(uint) {
		return balanceOf[_account];
	}
}
```

2. 작성한 컨트랙트를 트랜잭션으로 보내면 솔로 네트워크의 블록체인에 컨트랙트가 배포됨
3. 배포된 컨트랙트를 블록체인에 반영하려면 채굴 작업을 수행해야 함
4. GUI 애플리케이션에서 배포된 컨트랙트와 구현한 함수를 실행할 수 있음

# 2.2 이더리움 단일 상태 모델

## 2.2.1 이더리움 상태 전이 모델

- 상태: 계정의 상태(데이터
- 트랜잭션: 상태 전이를 유발하는 행위

### 현실 세계에서의 거래

은행에서 송금을 한다면 중앙 은행의 데이터베이스에 트랜잭션을 시간에 따라 기록한다. 모든 거래 유효성은 중앙 은행에서 검증하고 관리한다.

### 이더리움에서의 거래, 상태 전이

> 앞에서 `현실 세계에서의 거래`라는 말을 했으면 현실 거래랑 비교를 해야지 갑자기 왜 딴소리를?

- 이더리움에서의 상태 변이 함수: 송금 혹은 스마트 컨트랙트

상태 변이 함수는 잔액 혹은 계정의 특정한 정보를 바꿀 수 있다. 상태 1은 상태 변이 함수에 의해 상태 2가 된다. 즉, 하나의 상태는 여러개의 상태로 변이할 수 없고 오직 또 다른 하나의 상태로만 변경이 가능하다.

비트코인과의 다른 점은 비트코인은 남아있는 비트코인을 옮기는 상태 전이(UTXO`Unspent Transaction Outputs`)만이 가능한데, 이더리움은 스마트 컨트랙트를 이용해 계정의 모든 상태를 조작하는 것이 가능하다.

## 2.2.2 이더리움 플랫폼 참조 모델

이더리움은 다양한 패키지로 이루어져 있다.

### 데이터 계층

- accounts: 계정/지갑 등
- core: EVM, 제네시스 블록, 상태, 블록체인과 검증 방법 등
- les, light: 이더리움 경량 프로토콜을 이용해서 블록 헤더만 다운로드하는 라이트 체인
- trie: 머클 패트리시아 트리

### 합의 계층

- miner: 블록 생성과 마이닝 처리
- consensus: 이더리움 합의 엔진

### 실행 계층

- eth: 이더리움 프로토콜의 중앙 실행체
- contracts: 스마트 컨트랙트
- console: 도커, 베이그랜트 등의 컨테이너 관리
- ethclient: RPC API 이더리움 클라이언트
- node: 이더리움 P2P 노드

### 공통 계층

- p2p: P2P 네트워크 프로토콜
- ethdb: 이더리움 스토리지, 내부에서 레벨 DB 사용
- rpc: 외부로의 접속 관리 (http, pub/sub, websocket) 
- crypto: 암호화 함수들
- rlp: RLP 인코딩을 통한 직렬/역직렬화
- params: 각종 매개변수 정의들
- common: 유틸리티 함수
- event: 실시간 이벤트 처리
- metrics: 시스템 및 프로세스 모니터링

### 응용 계층

- mobile: 모바일용 API
- ethstats: 네트워크 상태 리포팅
- internal: 내부 함수들(api, web3, javascript...)
- swarm: P2P 분산 파일 서비스
- whisper: P2P 메시징 서비스
- cmd/bootnode: 이더리움 디스커버리 프로토콜을 위한 부트스트랩 노드 실행
- cmd/geth: 이더리움 공식 커맨드라인 클라이언트
- cmd/puppeth: 프라이빗 네트워크 관리 및 배포 도구
- cmd/rlpdump: rlp 데이터 출력 도구
